---
- name: Azure Unified Operations (Add Credentials & Get Instances)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    awx_host: "http://172.17.0.1:8052"
    awx_token: "dLzd4hXxJ7iOcdpkU0hZKK1ZN6reR0"
    azure_cred_type_name: "Microsoft Azure Resource Manager"

    credential_name: "Azure_{{ organization }}_{{ Name[:8] }}"
    operation: "add_credential" # options: add_credential / get_instances

  tasks:
    - name: Show selected operation
      debug:
        msg: "ðŸ”§ Running mode: {{ operation }}"

    ####################################################################
    # OPERATION 1: ADD OR UPDATE CREDENTIAL
    ####################################################################
    - block:
        - name: Show Credential Inputs
          debug:
            msg:
              - "Subscription: {{ Name }}"
              - "Client ID: {{ client }}"
              - "Tenant: {{ tenant }}"
              - "Organization: {{ organization }}"
              - "Credential Name: {{ credential_name }}"

        # ----------- Get Organization Info -----------
        - name: Get Organization ID
          uri:
            url: "{{ awx_host }}/api/v2/organizations/?name={{ organization | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: org_response

        - name: Validate Organization Exists
          fail:
            msg: "âŒ Organization '{{ organization }}' not found!"
          when: org_response.json.count == 0

        - set_fact:
            org_id: "{{ org_response.json.results[0].id }}"

        # ----------- Get Azure Credential Type -----------
        - name: Get Azure Credential Type ID
          uri:
            url: "{{ awx_host }}/api/v2/credential_types/?name={{ azure_cred_type_name | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: cred_type_response

        - fail:
            msg: "âŒ Azure credential type NOT found in AWX!"
          when: cred_type_response.json.count == 0

        - set_fact:
            cred_type_id: "{{ cred_type_response.json.results[0].id }}"

        # ----------- Check Credential Existence -----------
        - name: Check if credential exists
          uri:
            url: "{{ awx_host }}/api/v2/credentials/?name={{ credential_name | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: existing_cred

        # ----------- Create Credential -----------
        - name: Create Azure Credential
          uri:
            url: "{{ awx_host }}/api/v2/credentials/"
            method: POST
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            validate_certs: no
            status_code: [200,201]
            body:
              name: "{{ credential_name }}"
              description: "Azure credential for {{ organization }}"
              organization: "{{ org_id }}"
              credential_type: "{{ cred_type_id }}"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: azure_created
          when: existing_cred.json.count == 0

        # ----------- Update Credential -----------
        - name: Update Existing Azure Credential
          uri:
            url: "{{ awx_host }}/api/v2/credentials/{{ existing_cred.json.results[0].id }}/"
            method: PATCH
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            validate_certs: no
            status_code: [200,201]
            body:
              description: "Azure credential updated for {{ organization }}"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: azure_updated
          when: existing_cred.json.count > 0

        - name: Success Summary
          debug:
            msg:
              - "ðŸŽ‰ Azure Credential {{ 'created' if existing_cred.json.count == 0 else 'updated' }} successfully!"
              - "Name: {{ credential_name }}"
              - "Organization: {{ organization }}"
              - "Credential ID: {{ azure_created.json.id | default(existing_cred.json.results[0].id) }}"

      when: operation == "add_credential"

    ####################################################################
    # OPERATION 2: FETCH VM INSTANCE DETAILS
    ####################################################################
    - block:
        - name: Show VM Fetch Parameters
          debug:
            msg:
              - "Tenant: {{ tenant_id }}"
              - "Subscription: {{ subscription_id }}"
              - "Client: {{ client_id }}"

        - name: Azure Login
          shell: |
            az login --service-principal \
              --username {{ client_id }} \
              --password {{ client_secret }} \
              --tenant {{ tenant_id }}
          register: az_login
          no_log: true
          ignore_errors: yes

        - fail:
            msg: "âŒ Azure login failed!"
          when: az_login.rc != 0

        - name: Select Azure Subscription
          shell: az account set --subscription {{ subscription_id }}

        - name: Fetch VM list
          shell: az vm list --subscription {{ subscription_id }} --output json
          register: vm_list_raw

        - set_fact:
            azure_vms: "{{ vm_list_raw.stdout | from_json }}"

        - debug:
            msg: "Found {{ azure_vms | length }} VM(s)."

        - name: Fetch VM Details
          shell: |
            az vm show \
            --resource-group {{ item.resourceGroup }} \
            --name {{ item.name }} \
            --show-details \
            --output json
          loop: "{{ azure_vms }}"
          register: vm_details_raw
          when: azure_vms | length > 0

        - name: Format Instance Output
          set_fact:
            instances: "{{ vm_details_raw.results | map(attribute='stdout') | map('from_json') | list }}"

        - name: Display VM Details
          debug:
            var: instances

        - name: Azure Logout
          shell: az logout
          ignore_errors: yes

      when: operation == "get_instances"

