---
- name: Azure Unified Operations (Add Credentials & Get Instances)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    awx_host: "http://172.17.0.1:8052"
    awx_token: "dLzd4hXxJ7iOcdpkU0hZKK1ZN6reR0"
    encoded_azure_credtype: "{{ 'Microsoft Azure Resource Manager' | urlencode }}"
    credential_name: "Azure_{{ organization }}_{{ Name[:8] }}"
    operation: "add_credential"  # Default operation: "add_credential" or "get_instances"

  tasks:
    - name: Display operation type
      debug:
        msg: "üîß Operation: {{ operation }}"

    # ========================================
    # OPERATION 1: ADD CREDENTIALS
    # ========================================
    - name: Execute Add Credential Flow
      block:
        - name: Display credential input parameters
          debug:
            msg:
              - "Subscription ID: {{ Name }}"
              - "Application ID: {{ client }}"
              - "Tenant ID: {{ tenant }}"
              - "Organization: {{ organization }}"
              - "Credential Name: {{ credential_name }}"

        # -------------------- GET ORGANIZATION --------------------
        - name: Get organization ID
          uri:
            url: "{{ awx_host }}/api/v2/organizations/?name={{ organization }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: org_response

        - name: Set organization ID
          set_fact:
            org_id: "{{ org_response.json.results[0].id }}"
          when: org_response.json.count > 0

        - name: Fail if organization not found
          fail:
            msg: "‚ùå Organization '{{ organization }}' not found in AWX."
          when: org_response.json.count == 0

        # -------------------- GET CREDENTIAL TYPE --------------------
        - name: Get Azure credential type ID
          uri:
            url: "{{ awx_host }}/api/v2/credential_types/?name={{ encoded_azure_credtype }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: cred_type_response

        - name: Set credential type ID
          set_fact:
            cred_type_id: "{{ cred_type_response.json.results[0].id }}"
          when: cred_type_response.json.count > 0

        - name: Fail if credential type missing
          fail:
            msg: "‚ùå Azure Credential Type not found in AWX!"
          when: cred_type_response.json.count == 0

        # -------------------- CHECK IF CREDS EXIST --------------------
        - name: Check if credential already exists
          uri:
            url: "{{ awx_host }}/api/v2/credentials/?name={{ credential_name }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: existing_cred

        # -------------------- CREATE --------------------
        - name: Create Azure Credential in AWX
          uri:
            url: "{{ awx_host }}/api/v2/credentials/"
            method: POST
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            status_code: [200, 201]
            validate_certs: no
            body:
              name: "{{ credential_name }}"
              description: "Azure credential for {{ organization }}"
              organization: "{{ org_id }}"
              credential_type: "{{ cred_type_id }}"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: azure_created
          when: existing_cred.json.count == 0

        # -------------------- UPDATE --------------------
        - name: Update existing Azure Credential
          uri:
            url: "{{ awx_host }}/api/v2/credentials/{{ existing_cred.json.results[0].id }}/"
            method: PATCH
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            status_code: [200, 201]
            validate_certs: no
            body:
              description: "Azure credential for {{ organization }} (updated)"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: azure_updated
          when: existing_cred.json.count > 0

        # -------------------- SUMMARY --------------------
        - name: Display credential success message
          debug:
            msg:
              - "‚úÖ Azure Credential successfully {{ 'created' if existing_cred.json.count == 0 else 'updated' }}"
              - "Organization: {{ organization }}"
              - "Credential Name: {{ credential_name }}"
              - "Credential ID: {{ azure_created.json.id | default(existing_cred.json.results[0].id) }}"

      when: operation == "add_credential"

    # ========================================
    # OPERATION 2: GET INSTANCES
    # ========================================
    - name: Execute Get Instances Flow
      block:
        - name: Display instance fetch parameters
          debug:
            msg:
              - "Organization: {{ organization }}"
              - "Subscription ID: {{ subscription_id }}"
              - "Client ID: {{ client_id }}"
              - "Tenant ID: {{ tenant_id }}"

        # -------------------- AZURE LOGIN --------------------
        - name: Azure Login using Service Principal
          shell: |
            az login --service-principal \
              --username {{ client_id }} \
              --password {{ client_secret }} \
              --tenant {{ tenant_id }}
          no_log: true
          register: azure_login
          ignore_errors: yes

        - name: Check Azure login status
          fail:
            msg: "‚ùå Failed to login to Azure"
          when: azure_login.rc != 0

        - name: Set Azure Subscription
          shell: az account set --subscription {{ subscription_id }}
          when: azure_login.rc == 0

        # -------------------- GET ALL VMS --------------------
        - name: Get all Azure VMs
          shell: |
            az vm list --subscription {{ subscription_id }} --output json
          register: vm_list_raw

        - name: Parse VM list
          set_fact:
            azure_vms: "{{ vm_list_raw.stdout | from_json }}"

        - name: Display VM count
          debug:
            msg: "Found {{ azure_vms | length }} Azure VMs"

        # -------------------- GET DETAILED VM INFO --------------------
        - name: Get detailed VM information
          shell: |
            az vm show \
              --resource-group {{ item.resourceGroup }} \
              --name {{ item.name }} \
              --show-details \
              --output json
          loop: "{{ azure_vms }}"
          register: vm_details_raw
          when: azure_vms | length > 0

        # -------------------- FORMAT INSTANCE DATA --------------------
        - name: Format instance data
          set_fact:
            formatted_instances: >-
              {% set instances = [] %}
              {% for result in vm_details_raw.results %}
              {% set vm = result.stdout | from_json %}
              {% set instance = {
                'instance_id': vm.vmId | default(vm.id),
                'instance_name': vm.name,
                'status': vm.powerState | regex_replace('VM ', '') | lower if vm.powerState is defined else 'unknown',
                'vm_type': vm.hardwareProfile.vmSize,
                'os': vm.storageProfile.osDisk.osType,
                'location': vm.location,
                'private_ip': vm.privateIps | default('N/A'),
                'public_ip': vm.publicIps | default('N/A'),
                'resource_group': vm.resourceGroup,
                'cloud': 'AZ',
                'time_stamp': ansible_date_time.iso8601,
                'environment': vm.tags.environment | default('production') if vm.tags is defined else 'production',
                'applicationname': vm.tags.application | default(organization) if vm.tags is defined else organization
              } %}
              {% set _ = instances.append(instance) %}
              {% endfor %}
              {{ instances }}
          when: vm_details_raw.results is defined and vm_details_raw.results | length > 0

        # -------------------- HANDLE NO VMS --------------------
        - name: Set empty instances if no VMs found
          set_fact:
            formatted_instances: []
          when: azure_vms | length == 0

        # -------------------- RETURN DATA --------------------
        - name: Display instance results
          debug:
            msg: "‚úÖ Successfully fetched {{ formatted_instances | length }} Azure VM instances"

        - name: Set formatted instances as stats
          set_stats:
            data:
              instances: "{{ formatted_instances }}"
              count: "{{ formatted_instances | length }}"
              organization: "{{ organization }}"
              cloud: "AZ"

        - name: Display formatted instances
          debug:
            var: formatted_instances

        # -------------------- CLEANUP --------------------
        - name: Azure Logout
          shell: az logout
          ignore_errors: yes

      when: operation == "get_instances"

    # ========================================
    # INVALID OPERATION
    # ========================================
    - name: Handle invalid operation
      fail:
        msg: "‚ùå Invalid operation '{{ operation }}'. Must be 'add_credential' or 'get_instances'"
      when: operation not in ['add_credential', 'get_instances']
