---
- name: Azure Unified Operations (Add Credentials & Get Instances)
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    awx_host: "http://172.17.0.1:8052"
    awx_token: "YOUR_AWX_TOKEN"
    azure_cred_type_name: "Microsoft Azure Resource Manager"
    operation: "add_credential" # add_credential / get_instances

  tasks:

    - name: ðŸ“Œ Selected operation
      debug:
        msg: "ðŸ”§ Running: {{ operation }}"

    ##########################################################################
    # OPERATION 1: CREATE OR UPDATE AZURE CREDENTIAL IN AWX
    ##########################################################################
    - block:

        - name: ðŸ” Show Credential Inputs
          debug:
            msg:
              - "Subscription: {{ Name }}"
              - "Client: {{ client }}"
              - "Tenant: {{ tenant }}"
              - "Organization: {{ organization }}"
              - "Credential Name: Azure_{{ organization }}_{{ Name[:8] }}"

        - set_fact:
            credential_name: "Azure_{{ organization }}_{{ Name[:8] }}"

        # --- Retrieve organization from AWX ---
        - name: Get AWX Organization
          uri:
            url: "{{ awx_host }}/api/v2/organizations/?name={{ organization | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: org_response

        - name: â— Validate organization exists
          fail:
            msg: "âŒ Organization '{{ organization }}' not found in AWX!"
          when: org_response.json.results | length == 0

        - set_fact:
            org_id: "{{ org_response.json.results[0].id }}"

        # --- Retrieve credential type ---
        - name: Get Azure Credential Type from AWX
          uri:
            url: "{{ awx_host }}/api/v2/credential_types/?name={{ azure_cred_type_name | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: cred_response

        - name: â— Validate credential type exists
          fail:
            msg: "âŒ Azure credential type not found!"
          when: cred_response.json.results | length == 0

        - set_fact:
            cred_type_id: "{{ cred_response.json.results[0].id }}"

        # --- Check if credential already exists ---
        - name: Check if Azure credential already exists
          uri:
            url: "{{ awx_host }}/api/v2/credentials/?name={{ credential_name | urlencode }}"
            method: GET
            headers:
              Authorization: "Bearer {{ awx_token }}"
            validate_certs: no
          register: existing_cred

        # --- Create new credential ---
        - name: Create Azure Credential in AWX
          uri:
            url: "{{ awx_host }}/api/v2/credentials/"
            method: POST
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            validate_certs: no
            status_code: [200,201]
            body:
              name: "{{ credential_name }}"
              description: "Azure credential for {{ organization }}"
              organization: "{{ org_id }}"
              credential_type: "{{ cred_type_id }}"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: created_cred
          when: existing_cred.json.results | length == 0

        # --- Update credential if exists ---
        - name: Update existing Azure credential
          uri:
            url: "{{ awx_host }}/api/v2/credentials/{{ existing_cred.json.results[0].id }}/"
            method: PATCH
            headers:
              Authorization: "Bearer {{ awx_token }}"
              Content-Type: "application/json"
            body_format: json
            validate_certs: no
            status_code: [200,201]
            body:
              description: "Updated Azure credential for {{ organization }}"
              inputs:
                subscription: "{{ Name }}"
                client: "{{ client }}"
                secret: "{{ secret }}"
                tenant: "{{ tenant }}"
          register: updated_cred
          when: existing_cred.json.results | length > 0

        - name: âœ” Summary
          debug:
            msg:
              - "ðŸŽ‰ Credential {{ 'created' if existing_cred.json.results | length == 0 else 'updated' }} successfully!"
              - "Name: {{ credential_name }}"
              - "Organization: {{ organization }}"
              - "Credential ID: {{ created_cred.json.id | default(existing_cred.json.results[0].id) }}"

      when: operation == "add_credential"

    ##########################################################################
    # OPERATION 2: FETCH VM DETAILS
    ##########################################################################
    - block:

        - name: Show VM fetch input
          debug:
            msg:
              - "Tenant: {{ tenant_id }}"
              - "Subscription: {{ subscription_id }}"
              - "Client: {{ client_id }}"

        - name: Azure Login (Service Principal)
          shell: |
            az login --service-principal \
            --username {{ client_id }} \
            --password {{ client_secret }} \
            --tenant {{ tenant_id }}
          register: az_login
          no_log: false
          ignore_errors: false

        - name: Select Subscription
          shell: az account set --subscription {{ subscription_id }}

        - name: Fetch VM list
          shell: az vm list --subscription {{ subscription_id }} --output json
          register: vm_list_raw

        - set_fact:
            azure_vms: "{{ vm_list_raw.stdout | from_json }}"

        - debug:
            msg: "Found {{ azure_vms | length }} VM(s)"

        - name: Fetch Details for each VM
          shell: |
            az vm show \
            --resource-group {{ item.resourceGroup }} \
            --name {{ item.name }} \
            --show-details \
            --output json
          loop: "{{ azure_vms }}"
          register: vm_detail_raw

        - set_fact:
            vm_details: "{{ vm_detail_raw.results | map(attribute='stdout') | map('from_json') | list }}"

        - name: Show VM Details
          debug:
            var: vm_details

        - name: Logout from Azure
          shell: az logout

      when: operation == "get_instances"
